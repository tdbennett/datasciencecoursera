---
title: "Severe Weather Event Analysis"
author: "Tell Bennett"
date: "Monday, April 20, 2015"
output: html_document
---
    Title: Your document should have a title that briefly summarizes your data analysis

    Synopsis: Immediately after the title, there should be a synopsis which describes and summarizes your analysis in at most 10 complete sentences.

### Synopsis

10 sentences or less.



### Data Processing

```{r options, echo = FALSE}
#setwd("./ReproducibleResearch/Proj2/")
options(dplyr.max_print = 10)
options(dplyr.min_print =  5)
```

1) Loading packages

```{r loadpackages, echo = FALSE}
library(dplyr)
library(lubridate)
library(ggplot2)
library(stringr)
library(datasets)
library(htmlTable)
library(gridExtra)
```

2) Loading the raw data

```{r dataload, cache=TRUE}
## Download the data 
url <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
download.file(url, destfile = "stormdata.bz2", method="curl")

## Document the download time
downloadtime <- date()
downloadtime
## [1] "Thu Apr 23 13:38:11 2015"
```

3) Read the data into R
```{r dataread, cache=TRUE}
stormdata <- read.table("stormdata.bz2", sep = ",", header=TRUE, stringsAsFactors=FALSE)
```

4) Exploring the raw data to facilitate cleaning
```{r explore1}
dim(stormdata)
glimpse(stormdata)
summary(stormdata)
```

5) Extract the necessary variables
```{r extract, cache=TRUE}
stormdata <- transmute(stormdata,
        id = REFNUM,
        evtype = EVTYPE,
        state.abb = STATE,
        begindate = BGN_DATE,
        enddate = END_DATE,
        deaths = FATALITIES,
        injuries = INJURIES,
        propdmg = PROPDMG,
        propdmgexp = PROPDMGEXP,
        cropdmg = CROPDMG,
        cropdmgexp = CROPDMGEXP)
```

6) Check for duplicate events
```{r checking for duplicate events}
summarize(stormdata, unique=n_distinct(id))
```
No duplicate events found.


7) Clean the state field.  Because the question relates to the U.S., I excluded rows describing events that did not have a two-letter code for one of the 50 U.S. states
```{r cleanstate}
table(stormdata$state.abb, useNA = "always")

data(state)
state.abb

state2 <- state.abb

stormdata <- stormdata %>%
    filter(state.abb %in% state2)

table(stormdata$state.abb, useNA = "always")
```

7) Clean the dates
```{r cleandates, cache=TRUE}
stormdata2 <- str_split_fixed(stormdata$begindate, pattern = " ", 2)
stormdata3 <- str_split_fixed(stormdata$enddate, " ", 2)

stormdata <- cbind(stormdata, stormdata2[,1],stormdata3[,1])

stormdata <- stormdata %>%
        select(-begindate,-enddate) %>%
        mutate(begindate = mdy(stormdata2[,1]), enddate = stormdata3[,1]) 

stormdata <- stormdata[,c(1:9,12:13)]

rm(stormdata2)
rm(stormdata3)
```

8) Clean the property and crop damage fields
```{r cleanpropertycrop}

sum(is.na(stormdata$propdmg))
## No missing propdmg

sum(is.na(stormdata$cropdmg))
## No missing cropdmg

table(stormdata$propdmgexp, useNA = "always")
stormdata$propdmgexp[stormdata$propdmgexp=="0"] <- 1
stormdata$propdmgexp[stormdata$propdmgexp==""] <- 1
stormdata$propdmgexp[stormdata$propdmgexp=="-"] <- 1
stormdata$propdmgexp[stormdata$propdmgexp=="+"] <- 1
stormdata$propdmgexp[stormdata$propdmgexp=="?"] <- 1
stormdata$propdmgexp[stormdata$propdmgexp=="h"] <- 1000
stormdata$propdmgexp[stormdata$propdmgexp=="H"] <- 1000
stormdata$propdmgexp[stormdata$propdmgexp=="K"] <- 1000
stormdata$propdmgexp[stormdata$propdmgexp=="M"] <- 1000000
stormdata$propdmgexp[stormdata$propdmgexp=="m"] <- 1000000
stormdata$propdmgexp[stormdata$propdmgexp=="B"] <- 1000000000
table(stormdata$propdmgexp, useNA = "always")
## clean

table(stormdata$cropdmgexp, useNA = "always")
stormdata$cropdmgexp[stormdata$cropdmgexp=="0"] <- 1
stormdata$cropdmgexp[stormdata$cropdmgexp==""] <- 1
stormdata$cropdmgexp[stormdata$cropdmgexp=="?"] <- 1
stormdata$cropdmgexp[stormdata$cropdmgexp=="K"] <- 1000
stormdata$cropdmgexp[stormdata$cropdmgexp=="k"] <- 1000
stormdata$cropdmgexp[stormdata$cropdmgexp=="M"] <- 1000000
stormdata$cropdmgexp[stormdata$cropdmgexp=="m"] <- 1000000
stormdata$cropdmgexp[stormdata$cropdmgexp=="B"] <- 1000000000
table(stormdata$cropdmgexp, useNA = "always")

stormdata <- stormdata %>%
    mutate(propdmg = (propdmg*as.numeric(propdmgexp)), cropdmg = (cropdmg*as.numeric(cropdmgexp)))

fivenum(stormdata$propdmg)
fivenum(stormdata$cropdmg)
```
I assume in the above "Damage Exponent" fields that '0' means no multiplier (i.e. multiplier = 1), that 'h' and 'H' mean 10^2, that 'k' and 'K' mean 10^3, that 'm' and 'M' mean 10^6, and that 'B' means 10^9.  Other symbols were assumed to be typos and set to 1.  Other numbers were left as is.


8) Initial cleaning of the event type field
```{r cleanevtype}
table(stormdata$evtype, useNA = "always")
summarize(stormdata, unique=n_distinct(evtype))
### 952

### Changing all evtype strings to lower case and removing spaces at the beginning and end of strings
stormdata <- stormdata %>%
    mutate(evtype = tolower(str_trim(evtype)))
summarize(stormdata, unique=n_distinct(evtype))
### 860
```

9) Removing event types not associated with either health or property impact
```{r byev}
byev <- stormdata %>%
    group_by(evtype) %>%
    summarize(propimpact = sum(propdmg), 
              cropimpact = sum(cropdmg),
              injimpact = sum(injuries),
              deathimpact = sum(deaths),
              impact = sum(propimpact, cropimpact, injimpact, deathimpact)) %>%
    filter(impact > 0) %>%
    select(evtype)

stormdata <- inner_join(stormdata,byev)
```

Cleaning and categorizing the event type field
```{r categorizeeventtype, cache-TRUE}

### Winter storm
winterdata <- stormdata %>%
    mutate(winter = grepl("wint", evtype),
           snow = grepl("snow", evtype),
           cold = grepl("cold", evtype),
           blizz = grepl("blizzard", evtype),
           freeze = grepl("freez", evtype),
           ice = grepl("ice", evtype),
           icy = grepl("icy", evtype),
           chill = grepl("chill", evtype),
           sleet = grepl("sleet", evtype),
           avala = grepl("avala", evtype)) %>%
    filter(winter==T | snow==T | cold==T | blizz==T | ice==T | freeze==T | icy==T | chill==T | sleet==T | avala==T) %>%
    mutate(evtype2 = "winter") %>%
    select(id,evtype2)

stormdata <- left_join(stormdata,winterdata)
stormdata$evtype[stormdata$evtype2=="winter"] <- "Winter"
table(stormdata$evtype, useNA = "always")
stormdata <- select(stormdata, -evtype2)
rm(winterdata)

### Fire
firedata <- stormdata %>%
    mutate(fire = grepl("fire", evtype)) %>%
    filter(fire==T) %>%
    mutate(evtype2 = "fire") %>%
    select(id,evtype2)

stormdata <- left_join(stormdata,firedata)
stormdata$evtype[stormdata$evtype2=="fire"] <- "Fire"
table(stormdata$evtype, useNA = "always")
stormdata <- select(stormdata, -evtype2)
rm(firedata)


### Heat
heatdata <- stormdata %>%
    mutate(heat = grepl("heat", evtype),
           warm = grepl("warm", evtype)) %>%
    filter(heat==T | warm==T) %>%
    mutate(evtype2 = "heat") %>%
    select(id,evtype2)

stormdata <- left_join(stormdata,heatdata)
stormdata$evtype[stormdata$evtype2=="heat"] <- "Heat"
table(stormdata$evtype, useNA = "always")
stormdata <- select(stormdata, -evtype2)
rm(heatdata)


### Flood
flooddata <- stormdata %>%
    mutate(flood = grepl("flood", evtype),
           fld = grepl("fld", evtype)) %>%
    filter(flood==T | fld==T) %>%
    mutate(evtype2 = "flood") %>%
    select(id,evtype2)

stormdata <- left_join(stormdata,flooddata)
stormdata$evtype[stormdata$evtype2=="flood"] <- "Flood"
table(stormdata$evtype, useNA = "always")
stormdata <- select(stormdata, -evtype2)
rm(flooddata)


### Wind
winddata <- stormdata %>%
    mutate(wind = grepl("wind", evtype)) %>%
    filter(wind==T) %>%
    mutate(evtype2 = "wind") %>%
    select(id,evtype2)

stormdata <- left_join(stormdata,winddata)
stormdata$evtype[stormdata$evtype2=="wind"] <- "Wind"
table(stormdata$evtype, useNA = "always")
stormdata <- select(stormdata, -evtype2)
rm(winddata)


### Hail
haildata <- stormdata %>%
    mutate(hail = grepl("hail", evtype)) %>%
    filter(hail==T) %>%
    mutate(evtype2 = "hail") %>%
    select(id,evtype2)

stormdata <- left_join(stormdata,haildata)
stormdata$evtype[stormdata$evtype2=="hail"] <- "Hail"
table(stormdata$evtype, useNA = "always")
stormdata <- select(stormdata, -evtype2)
rm(haildata)


### Fog
fogdata <- stormdata %>%
    mutate(fog = grepl("fog", evtype)) %>%
    filter(fog==T) %>%
    mutate(evtype2 = "fog") %>%
    select(id,evtype2)

stormdata <- left_join(stormdata,fogdata)
stormdata$evtype[stormdata$evtype2=="fog"] <- "Fog"
table(stormdata$evtype, useNA = "always")
stormdata <- select(stormdata, -evtype2)
rm(fogdata)


### Lightning
lightningdata <- stormdata %>%
    mutate(lightning = grepl("lig", evtype)) %>%
    filter(lightning==T) %>%
    mutate(evtype2 = "lightning") %>%
    select(id,evtype2)

stormdata <- left_join(stormdata,lightningdata)
stormdata$evtype[stormdata$evtype2=="lightning"] <- "Lightning"
table(stormdata$evtype, useNA = "always")
stormdata <- select(stormdata, -evtype2)
rm(lightningdata)


### Tornado
tornadodata <- stormdata %>%
    mutate(tornado = grepl("torn", evtype),
           spout = grepl("waterspout", evtype),
           funnel = grepl("funnel", evtype)) %>%
    filter(tornado==T | spout==T | funnel==T) %>%
    mutate(evtype2 = "tornado") %>%
    select(id,evtype2)

stormdata <- left_join(stormdata,tornadodata)
stormdata$evtype[stormdata$evtype2=="tornado"] <- "Tornado"
table(stormdata$evtype, useNA = "always")
stormdata <- select(stormdata, -evtype2)
rm(tornadodata)


### Rainstorm
raindata <- stormdata %>%
    mutate(rain = grepl("rain", evtype),
           storm = grepl("storm", evtype),
           tstm = grepl("tstm", evtype),
           precip = grepl("precip", evtype)) %>%
    filter(rain==T | storm==T | tstm==T | precip==T) %>%
    mutate(evtype2 = "Rainstorm") %>%
    select(id,evtype2)

stormdata <- left_join(stormdata,raindata)
stormdata$evtype[stormdata$evtype2=="Rainstorm"] <- "Rainstorm"
table(stormdata$evtype, useNA = "always")
stormdata <- select(stormdata, -evtype2)
rm(raindata)


### Tropical Storms/Hurricanes
tropdata <- stormdata %>%
    mutate(trop = grepl("trop", evtype),
           hurr = grepl("hurr", evtype),
           tsu = grepl("tsu", evtype)) %>%
    filter(trop==T | hurr==T | tsu==T) %>%
    mutate(evtype2 = "Trop/Hurr") %>%
    select(id,evtype2)

stormdata <- left_join(stormdata,tropdata)
stormdata$evtype[stormdata$evtype2=="Trop/Hurr"] <- "Trop/Hurr"
table(stormdata$evtype, useNA = "always")
stormdata <- select(stormdata, -evtype2)
rm(tropdata)


### Drought
droughtdata <- stormdata %>%
    mutate(drought = grepl("drought", evtype),
           dry = grepl("dry", evtype)) %>%
    filter(drought==T | dry==T) %>%
    mutate(evtype2 = "drought") %>%
    select(id,evtype2)

stormdata <- left_join(stormdata,droughtdata)
stormdata$evtype[stormdata$evtype2=="drought"] <- "Drought"
table(stormdata$evtype, useNA = "always")
stormdata <- select(stormdata, -evtype2)
rm(droughtdata)


### Land or Mudslide
landdata <- stormdata %>%
    mutate(land = grepl("land", evtype),
           mud = grepl("mud", evtype)) %>%
    filter(land==T | mud==T) %>%
    mutate(evtype2 = "Land- or Mudslide") %>%
    select(id,evtype2)

stormdata <- left_join(stormdata,landdata)
stormdata$evtype[stormdata$evtype2=="Land- or Mudslide"] <- "Land- or Mudslide"
table(stormdata$evtype, useNA = "always")
stormdata <- select(stormdata, -evtype2)
rm(landdata)
            

### Coastal Events
coastdata <- stormdata %>%
    mutate(sea = grepl("sea", evtype),
           rip = grepl("rip", evtype),
           surf = grepl("surf", evtype),
           wave = grepl("wave", evtype),
           tide = grepl("tide", evtype),
           coast = grepl("coast", evtype)) %>%
    filter(sea==T | rip==T | surf==T | wave==T | tide==T | coast==T) %>%
    mutate(evtype2 = "Coastal Events") %>%
    select(id,evtype2)

stormdata <- left_join(stormdata,coastdata)
stormdata$evtype[stormdata$evtype2=="Coastal Events"] <- "Coastal Events"
table(stormdata$evtype, useNA = "always")
stormdata <- select(stormdata, -evtype2)
rm(coastdata)



### All other categories have <200 events (max 149, dust devil)
filter <- stormdata %>%
    group_by(evtype) %>%
    summarize(count = n()) %>%
    filter(count >200)

### Dropping the events that have <200 records
stormdata <- semi_join(stormdata, filter)

### Checking
stormdata %>%
    group_by(evtype) %>%
    summarize(count = n())

### Cleaning up
rm(filter)
rm(byev)
```



Exploratory analysis - events over time
```{r eventsovertime}
table(stormdata$evtype, useNA = "always")

byyear <- stormdata %>%
    group_by(year2 = year(begindate),evtype) %>%
    summarize(count = n())

ggplot(byyear, aes(x=year2, y=count)) +
    geom_line(aes(colour = evtype, linetype=evtype), size=1) +
    theme_bw(base_size = 12, base_family= "") +
    xlab("Year") +
    ylab("Number of Events") +
    ggtitle("Storm Events over Time") +
    labs(colour = "Event Type", linetype = "Event Type")
```


Further exploratory analyses - bringing in U.S. Division/Region variables and analyzing events by state
```{r eventsbystate}
state.region
state.division

stateinfo <- data.frame(state.abb,state.division)

stormdata <- left_join(stormdata,stateinfo)

## Checking the join
nrow(stormdata)
table(stormdata$state.abb, useNA = "always")
table(stormdata$state.division, useNA = "always")

bystate <- stormdata %>%
    group_by(state.abb, evtype) %>%
    summarize(count = n())
```

```{r eventsbystateandregionplot}
plot1 <- ggplot(stormdata, aes(state.abb, fill=evtype)) +
    geom_bar() + 
    theme_bw(base_size = 12, base_family= "") +
    ylab("Number of Events") +
    xlab("State") +
    ggtitle("Storm Events by State") +
    labs(fill = "Event Type") +
    theme(axis.title.x = element_text(face="bold"), axis.title.y = element_text(face="bold"),
          axis.text.x = element_text(angle=90), title = element_text(face="bold"))

plot2 <- ggplot(stormdata, aes(state.division, fill=evtype)) +
    geom_bar() + coord_flip() +
    theme_bw(base_size = 12, base_family= "") +
    ylab("Number of Events") +
    xlab("Region") +
    ggtitle("Storm Events by U.S. Region") +
    labs(fill = "Event Type") +
    theme(axis.title.x = element_text(face="bold"), axis.title.y = element_text(face="bold"),
          title = element_text(face="bold"), axis.text.x = element_text(angle=90))

grid.arrange(plot1,plot2)

rm(plot1)
rm(plot2)
```


Health impacts - Overall, by Event Type
```{r pophealth table}
byevtype <- stormdata %>%
    rename(EventType = evtype) %>%
    group_by(EventType) %>%
    summarize(Count = n(),
              Injuries = sum(injuries), 
              Deaths = sum(deaths),
              InjuriesPerEvent = signif((Injuries/Count), digits=2),
              DeathsPerEvent = signif((Deaths/Count), digits=2))
byevtype

htmlTable(byevtype,
          rnames = FALSE,
          caption = "<a name=table01></a> <b> Table 1 </b> Injuries and Deaths by Event Type",
          align = "lccccc",
          align.header = "lccccc")
```


Health impacts scaled to state population, by event Type
```{r pophealthstate}
state.name
state.x77

statex77 <- as.data.frame(state.x77, stringsAsFactors=FALSE)
stateinfo2 <- cbind(state.abb,statex77)

stormdata <- left_join(stormdata,stateinfo2)

## Checking the join
nrow(stormdata)
table(stormdata$state.abb, useNA = "always")
table(stormdata$state.division, useNA = "always")

## Removing some unnecessary variables
stormdata <- stormdata %>%
    select(-Illiteracy, -Murder, -contains("Grad"), -Frost, -Area)

byevtypestatepop <- stormdata %>%
    group_by(state.abb, evtype) %>%
    summarize(injper1000 = (sum(injuries)/1000), deathsper1000 = (sum(deaths)/1000))

byevtypedivpop <- stormdata %>%
    group_by(state.division, evtype) %>%
    summarize(injper1000 = (sum(injuries)/1000), deathsper1000 = (sum(deaths)/1000))
```


Bar graphs of Population Health Impact by Event for each State
```{r healthbystateplot}
plot1 <- ggplot(byevtypestatepop, aes(x = state.abb, y = injper1000, fill = evtype)) +
    geom_bar(stat = "identity") +
    theme_bw(base_size = 12, base_family= "") +
    ylab("Injuries per 1000 population") +
    xlab("State") +
    ggtitle("Injuries per 1000 by U.S. State") +
    labs(fill = "Event Type") +
    theme(axis.title.x = element_text(face="bold"), axis.title.y = element_text(face="bold"),
          axis.text.x = element_text(angle=90), title = element_text(face="bold"))

plot2 <- ggplot(byevtypestatepop, aes(x = state.abb, y = deathsper1000, fill = evtype)) +
    geom_bar(stat = "identity") +
    theme_bw(base_size = 12, base_family= "") +
    ylab("Deaths per 1000 population") +
    xlab("State") +
    ggtitle("Deaths per 1000 by U.S. State") +
    labs(fill = "Event Type") +
    theme(axis.title.x = element_text(face="bold"), axis.title.y = element_text(face="bold"),
          axis.text.x = element_text(angle=90), title = element_text(face="bold"))

grid.arrange(plot1, plot2)

### Cleaning up
rm(plot1)
rm(plot2)
rm(byevtypestatepop)
```


Economic Impact Overall, by Event Type
```{r econimpact}
byevtype2 <- stormdata %>%
    rename(EventType = evtype) %>%
    group_by(EventType) %>%
    summarize(
        AvePropertyDamage = round(mean(propdmg, na.rm=TRUE), 0), 
        AveCropDamage = round(mean(cropdmg, na.rm=TRUE), 0),
        minpropdmg = min(propdmg),
        maxpropdmg = max(propdmg)) %>%
    select(EventType, AvePropertyDamage, AveCropDamage)
byevtype2
```
It looks like only tornados have property damage estimates.  None of the records thus far have crop damage estimates.

```{r econimpact table}
htmlTable(byevtype2,
          rnames = FALSE,
          header = c("Event Type", "Mean Property Damage ($)", "Mean Crop Damage ($)"),
          caption = "<a name=table02></a> <b> Table 2 </b> Property Damage by Event Type",
          align = "lcc",
          align.header = "lcc")
```



reference: https://stat.ethz.ch/R-manual/R-devel/library/datasets/html/state.html


3) Reference documentation
Put in a hyperlink to https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf

FAQ location 
https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2FNCDC%20Storm%20Events-FAQ%20Page.pdf

Years for each event type
http://www.ncdc.noaa.gov/stormevents/details.jsp

Field details
ftp://ftp.ncdc.noaa.gov/pub/data/swdi/stormevents/csvfiles/Storm-Data-Export-Format.docx

### Results

