---
title: "Human Activity Recognition Project"
author: "Tell Bennett"
output: html_document
---



Synopsis
--------




Data Processing
---------------

```{r options, echo = FALSE}
options(dplyr.max_print = 10)
options(dplyr.min_print =  5)
```

  

1) Load R packages

```{r loadpackages, echo = TRUE, results="hide", message=FALSE}
library(dplyr)
library(caret)
library(readr)

library(lubridate)
library(ggplot2)
library(stringr)
library(htmlTable)
```

  
  
  

2) Load the raw data

```{r dataload, cache=TRUE}
## Download the train data 
trainurl <- "https://d396qusza40orc.cloudfront.net/predmachlearn/pml-training.csv"
download.file(trainurl, destfile = "PracticalMachineLearning/data/pml-training.csv")

## Document the download time
traindownloadtime <- date()
traindownloadtime



## Download the train data 
testurl <- "https://d396qusza40orc.cloudfront.net/predmachlearn/pml-testing.csv"
download.file(testurl, destfile = "PracticalMachineLearning/data/pml-testing.csv")

## Document the download time
testdownloadtime <- date()
testdownloadtime

```

  
  
  

3) Read the data into R

```{r dataread, cache=TRUE}
training <- read_csv("PracticalMachineLearning/data/pml-training.csv")
testing <- read_csv("PracticalMachineLearning/data/pml-testing.csv")
```

  
  
  

4) Exploring the raw data and initial cleaning
```{r explore1, echo = FALSE, results="hide", message=FALSE}
dim(training)
dim(testing)
glimpse(training)
names(training)
head(training)
tail(training)
summary(training)  ### a number of the variables have substantial missing data


### dropping the columns with lots (more than 19000/19622 total rows) of missing data
training <- training[, sapply(training, function(x) sum(is.na(x))) < 19000]
```

  
  
  

5) Select the necessary variables
```{r extract, cache=TRUE}
training %<>%
     select()
        id = REFNUM,
        evtype = EVTYPE,
        state.abb = STATE,
        begindate = BGN_DATE,
        enddate = END_DATE,
        deaths = FATALITIES,
        injuries = INJURIES,
        propdmg = PROPDMG,
        propdmgexp = PROPDMGEXP,
        cropdmg = CROPDMG,
        cropdmgexp = CROPDMGEXP)
```

  
  
  

6) Check for duplicate events
```{r checking for duplicate events}
summarize(stormdata, unique=n_distinct(id))
```
No duplicate events found.

  
  
  
  

7) Clean the state field.  Because the question relates to the U.S., I excluded rows describing events that did not have a two-letter code for one of the 50 U.S. states.  I loaded the 'state' dataset included in the 'datasets' [package](https://stat.ethz.ch/R-manual/R-devel/library/datasets/html/state.html) in R in order to access files that contain the 50 U.S. state abbreviations and U.S. regions (used below).
```{r cleanstate}
table(stormdata$state.abb, useNA = "always")

data(state)
state.abb

state2 <- state.abb

stormdata <- stormdata %>%
    filter(state.abb %in% state2)

table(stormdata$state.abb, useNA = "always")
```
The data file now contains only events that occurred in one of the 50 U.S. states.

  
  
  

8) Clean the dates
```{r cleandates, cache=TRUE}
stormdata2 <- str_split_fixed(stormdata$begindate, pattern = " ", 2)
stormdata3 <- str_split_fixed(stormdata$enddate, " ", 2)

stormdata <- cbind(stormdata, stormdata2[,1],stormdata3[,1])

stormdata <- stormdata %>%
        select(-begindate,-enddate) %>%
        mutate(begindate = mdy(stormdata2[,1]), enddate = stormdata3[,1]) 

stormdata <- stormdata[,c(1:9,12:13)]

rm(stormdata2)
rm(stormdata3)
```

  
  
  

9) Clean the property and crop damage fields.  I assume in the below "Damage Exponent" fields (one each for property and crop) that '0' means no multiplier (i.e. multiplier = 1), that 'h' and 'H' mean 10^2, that 'k' and 'K' mean 10^3, that 'm' and 'M' mean 10^6, and that 'B' means 10^9.  Other symbols were assumed to be typos and set to 1.  Other numbers were left as is.
```{r cleanpropertycrop, cache=TRUE}

sum(is.na(stormdata$propdmg))
## No missing propdmg

sum(is.na(stormdata$cropdmg))
## No missing cropdmg

table(stormdata$propdmgexp, useNA = "always")
stormdata$propdmgexp[stormdata$propdmgexp=="0"] <- 1
stormdata$propdmgexp[stormdata$propdmgexp==""] <- 1
stormdata$propdmgexp[stormdata$propdmgexp=="-"] <- 1
stormdata$propdmgexp[stormdata$propdmgexp=="+"] <- 1
stormdata$propdmgexp[stormdata$propdmgexp=="?"] <- 1
stormdata$propdmgexp[stormdata$propdmgexp=="h"] <- 1000
stormdata$propdmgexp[stormdata$propdmgexp=="H"] <- 1000
stormdata$propdmgexp[stormdata$propdmgexp=="K"] <- 1000
stormdata$propdmgexp[stormdata$propdmgexp=="M"] <- 1000000
stormdata$propdmgexp[stormdata$propdmgexp=="m"] <- 1000000
stormdata$propdmgexp[stormdata$propdmgexp=="B"] <- 1000000000
table(stormdata$propdmgexp, useNA = "always")
## clean

table(stormdata$cropdmgexp, useNA = "always")
stormdata$cropdmgexp[stormdata$cropdmgexp=="0"] <- 1
stormdata$cropdmgexp[stormdata$cropdmgexp==""] <- 1
stormdata$cropdmgexp[stormdata$cropdmgexp=="?"] <- 1
stormdata$cropdmgexp[stormdata$cropdmgexp=="K"] <- 1000
stormdata$cropdmgexp[stormdata$cropdmgexp=="k"] <- 1000
stormdata$cropdmgexp[stormdata$cropdmgexp=="M"] <- 1000000
stormdata$cropdmgexp[stormdata$cropdmgexp=="m"] <- 1000000
stormdata$cropdmgexp[stormdata$cropdmgexp=="B"] <- 1000000000
table(stormdata$cropdmgexp, useNA = "always")

stormdata <- stormdata %>%
    mutate(propdmg = (propdmg*as.numeric(propdmgexp)), cropdmg = (cropdmg*as.numeric(cropdmgexp)))

fivenum(stormdata$propdmg)
fivenum(stormdata$cropdmg)
```

  
  
  

10) Initial cleaning of the event type field
```{r cleanevtype,cache=TRUE}
summarize(stormdata, unique=n_distinct(evtype))

### Changing all evtype strings to lower case and removing spaces at the beginning and end of strings
stormdata <- stormdata %>%
    mutate(evtype = tolower(str_trim(evtype)))
summarize(stormdata, unique=n_distinct(evtype))
```

  
  
  
  

11) Removing event types not associated with either health or property impact
```{r byev, cache=TRUE,message=FALSE}
byev <- stormdata %>%
    group_by(evtype) %>%
    summarize(propimpact = sum(propdmg), 
              cropimpact = sum(cropdmg),
              injimpact = sum(injuries),
              deathimpact = sum(deaths),
              impact = sum(propimpact, cropimpact, injimpact, deathimpact)) %>%
    filter(impact > 0) %>%
    select(evtype)

stormdata <- inner_join(stormdata,byev)
### This join removes those without either health or property impact
```

  
  
  
  

12) Cleaning and categorizing the event type field.  The strings that I categorized into each Event Type category are shown within the first 'mutate' call for each category (e.g. 'Winter Storm').
```{r categorizeeventtype, cache-TRUE,message=FALSE}

### Winter storm
winterdata <- stormdata %>%
    mutate(winter = grepl("wint", evtype),
           snow = grepl("snow", evtype),
           cold = grepl("cold", evtype),
           blizz = grepl("blizzard", evtype),
           freeze = grepl("freez", evtype),
           ice = grepl("ice", evtype),
           icy = grepl("icy", evtype),
           chill = grepl("chill", evtype),
           sleet = grepl("sleet", evtype),
           avala = grepl("avala", evtype)) %>%
    filter(winter==T | snow==T | cold==T | blizz==T | ice==T | freeze==T | icy==T | chill==T | sleet==T | avala==T) %>%
    mutate(evtype2 = "winter") %>%
    select(id,evtype2)

stormdata <- left_join(stormdata,winterdata)
stormdata$evtype[stormdata$evtype2=="winter"] <- "Winter"
#table(stormdata$evtype, useNA = "always")
stormdata <- select(stormdata, -evtype2)
rm(winterdata)

### Fire
firedata <- stormdata %>%
    mutate(fire = grepl("fire", evtype)) %>%
    filter(fire==T) %>%
    mutate(evtype2 = "fire") %>%
    select(id,evtype2)

stormdata <- left_join(stormdata,firedata)
stormdata$evtype[stormdata$evtype2=="fire"] <- "Fire"
#table(stormdata$evtype, useNA = "always")
stormdata <- select(stormdata, -evtype2)
rm(firedata)


### Heat
heatdata <- stormdata %>%
    mutate(heat = grepl("heat", evtype),
           warm = grepl("warm", evtype)) %>%
    filter(heat==T | warm==T) %>%
    mutate(evtype2 = "heat") %>%
    select(id,evtype2)

stormdata <- left_join(stormdata,heatdata)
stormdata$evtype[stormdata$evtype2=="heat"] <- "Heat"
#table(stormdata$evtype, useNA = "always")
stormdata <- select(stormdata, -evtype2)
rm(heatdata)


### Flood
flooddata <- stormdata %>%
    mutate(flood = grepl("flood", evtype),
           fld = grepl("fld", evtype)) %>%
    filter(flood==T | fld==T) %>%
    mutate(evtype2 = "flood") %>%
    select(id,evtype2)

stormdata <- left_join(stormdata,flooddata)
stormdata$evtype[stormdata$evtype2=="flood"] <- "Flood"
#table(stormdata$evtype, useNA = "always")
stormdata <- select(stormdata, -evtype2)
rm(flooddata)


### Wind
winddata <- stormdata %>%
    mutate(wind = grepl("wind", evtype)) %>%
    filter(wind==T) %>%
    mutate(evtype2 = "wind") %>%
    select(id,evtype2)

stormdata <- left_join(stormdata,winddata)
stormdata$evtype[stormdata$evtype2=="wind"] <- "Wind"
#table(stormdata$evtype, useNA = "always")
stormdata <- select(stormdata, -evtype2)
rm(winddata)


### Hail
haildata <- stormdata %>%
    mutate(hail = grepl("hail", evtype)) %>%
    filter(hail==T) %>%
    mutate(evtype2 = "hail") %>%
    select(id,evtype2)

stormdata <- left_join(stormdata,haildata)
stormdata$evtype[stormdata$evtype2=="hail"] <- "Hail"
#table(stormdata$evtype, useNA = "always")
stormdata <- select(stormdata, -evtype2)
rm(haildata)


### Fog
fogdata <- stormdata %>%
    mutate(fog = grepl("fog", evtype)) %>%
    filter(fog==T) %>%
    mutate(evtype2 = "fog") %>%
    select(id,evtype2)

stormdata <- left_join(stormdata,fogdata)
stormdata$evtype[stormdata$evtype2=="fog"] <- "Fog"
#table(stormdata$evtype, useNA = "always")
stormdata <- select(stormdata, -evtype2)
rm(fogdata)


### Lightning
lightningdata <- stormdata %>%
    mutate(lightning = grepl("lig", evtype)) %>%
    filter(lightning==T) %>%
    mutate(evtype2 = "lightning") %>%
    select(id,evtype2)

stormdata <- left_join(stormdata,lightningdata)
stormdata$evtype[stormdata$evtype2=="lightning"] <- "Lightning"
#table(stormdata$evtype, useNA = "always")
stormdata <- select(stormdata, -evtype2)
rm(lightningdata)


### Tornado
tornadodata <- stormdata %>%
    mutate(tornado = grepl("torn", evtype),
           spout = grepl("waterspout", evtype),
           funnel = grepl("funnel", evtype)) %>%
    filter(tornado==T | spout==T | funnel==T) %>%
    mutate(evtype2 = "tornado") %>%
    select(id,evtype2)

stormdata <- left_join(stormdata,tornadodata)
stormdata$evtype[stormdata$evtype2=="tornado"] <- "Tornado"
#table(stormdata$evtype, useNA = "always")
stormdata <- select(stormdata, -evtype2)
rm(tornadodata)


### Rainstorm
raindata <- stormdata %>%
    mutate(rain = grepl("rain", evtype),
           storm = grepl("storm", evtype),
           tstm = grepl("tstm", evtype),
           precip = grepl("precip", evtype)) %>%
    filter(rain==T | storm==T | tstm==T | precip==T) %>%
    mutate(evtype2 = "Rainstorm") %>%
    select(id,evtype2)

stormdata <- left_join(stormdata,raindata)
stormdata$evtype[stormdata$evtype2=="Rainstorm"] <- "Rainstorm"
#table(stormdata$evtype, useNA = "always")
stormdata <- select(stormdata, -evtype2)
rm(raindata)


### Tropical Storms/Hurricanes
tropdata <- stormdata %>%
    mutate(trop = grepl("trop", evtype),
           hurr = grepl("hurr", evtype),
           tsu = grepl("tsu", evtype)) %>%
    filter(trop==T | hurr==T | tsu==T) %>%
    mutate(evtype2 = "Trop/Hurr") %>%
    select(id,evtype2)

stormdata <- left_join(stormdata,tropdata)
stormdata$evtype[stormdata$evtype2=="Trop/Hurr"] <- "Trop/Hurr"
#table(stormdata$evtype, useNA = "always")
stormdata <- select(stormdata, -evtype2)
rm(tropdata)


### Drought
droughtdata <- stormdata %>%
    mutate(drought = grepl("drought", evtype),
           dry = grepl("dry", evtype)) %>%
    filter(drought==T | dry==T) %>%
    mutate(evtype2 = "drought") %>%
    select(id,evtype2)

stormdata <- left_join(stormdata,droughtdata)
stormdata$evtype[stormdata$evtype2=="drought"] <- "Drought"
#table(stormdata$evtype, useNA = "always")
stormdata <- select(stormdata, -evtype2)
rm(droughtdata)


### Land or Mudslide
landdata <- stormdata %>%
    mutate(land = grepl("land", evtype),
           mud = grepl("mud", evtype)) %>%
    filter(land==T | mud==T) %>%
    mutate(evtype2 = "Land- or Mudslide") %>%
    select(id,evtype2)

stormdata <- left_join(stormdata,landdata)
stormdata$evtype[stormdata$evtype2=="Land- or Mudslide"] <- "Land- or Mudslide"
#table(stormdata$evtype, useNA = "always")
stormdata <- select(stormdata, -evtype2)
rm(landdata)
            

### Coastal Events
coastdata <- stormdata %>%
    mutate(sea = grepl("sea", evtype),
           rip = grepl("rip", evtype),
           surf = grepl("surf", evtype),
           wave = grepl("wave", evtype),
           tide = grepl("tide", evtype),
           coast = grepl("coast", evtype)) %>%
    filter(sea==T | rip==T | surf==T | wave==T | tide==T | coast==T) %>%
    mutate(evtype2 = "Coastal Events") %>%
    select(id,evtype2)

stormdata <- left_join(stormdata,coastdata)
stormdata$evtype[stormdata$evtype2=="Coastal Events"] <- "Coastal Events"
#table(stormdata$evtype, useNA = "always")
stormdata <- select(stormdata, -evtype2)
rm(coastdata)
```

  
  
  
 
13) All other categories have fewer than 200 events (max 149, dust devil).  I excluded these small categories below.
```{r filter, cache=TRUE, message=FALSE}
filter <- stormdata %>%
    group_by(evtype) %>%
    summarize(count = n()) %>%
    filter(count >200)

### Dropping the events that have <200 records
stormdata <- semi_join(stormdata, filter)

### Checking
stormdata %>%
    group_by(evtype) %>%
    summarize(count = n())

### Cleaning up
rm(filter)
rm(byev)
```

  
  
  

Results - Events overall
------------------------

1) Exploratory analysis - events over time
```{r eventsovertime}
byyear <- stormdata %>%
    group_by(year2 = year(begindate),evtype) %>%
    summarize(count = n())

ggplot(byyear, aes(x=year2, y=count)) +
    geom_line(aes(colour = evtype, linetype=evtype), size=1) +
    theme_bw(base_size = 12, base_family= "") +
    xlab("Year") +
    ylab("Number of Events") +
    ggtitle("Figure 1: Storm Events over Time") +
    labs(colour = "Event Type", linetype = "Event Type")
```

As described in NOAA's Storm Event database [reference material](http://www.ncdc.noaa.gov/stormevents/details.jsp), tornado data is available from 1950-, and hail and 'thunderstorm wind' event data from 1955-.  Data for the many other categories are only available since 1996.

  
  
  
 

2) Plot of Storm Events by U.S. State and Region
```{r eventsbystateplot}
plot1 <- ggplot(stormdata, aes(state.abb, fill=evtype)) +
    geom_bar() + 
    theme_bw(base_size = 12, base_family= "") +
    ylab("Number of Events") +
    xlab("State") +
    ggtitle("Figure 2: Storm Events by State") +
    labs(fill = "Event Type") +
    theme(axis.title.x = element_text(face="bold"), axis.title.y = element_text(face="bold"),
          axis.text.x = element_text(angle=90), title = element_text(face="bold"))
plot1

rm(plot1)
```

As one might expect based on geography, the types of storm events in each U.S. state vary widely.  Government officials and planners need to account for local events in their use of these data.  
  
  
  
  

Results - Population Health Impact of Storm Events
--------------------------------------------------
  
1) Health impacts - Overall, by Event Type
```{r pophealth table}
byevtype <- stormdata %>%
    rename(EventType = evtype) %>%
    group_by(EventType) %>%
    summarize(Count = n(),
              Injuries = sum(injuries), 
              Deaths = sum(deaths),
              InjuriesPerEvent = signif((Injuries/Count), digits=2),
              DeathsPerEvent = signif((Deaths/Count), digits=2))
# byevtype

htmlTable(byevtype,
          rnames = FALSE,
          caption = "<a name=table01></a> <b> Table 1 </b> Injuries and Deaths by Event Type",
          align = "llllll",
          align.header = "llllll")
```

Heat events cause the most deaths and injuries per event.  Tropical depressions/storms and hurricanes cause nearly as many injuries per event, but fewer deaths.  Population health efforts in areas that are subject to summer heat waves might be directed at identifying people vulnerable to heat injury (the elderly, for example) who might need assistance if a heat wave occurred.  Coastal areas subject to major tropical depressions/storms and hurricanes might focus resources on enforcing evacuation orders, for example.
  
  
  
  

2) Health impacts scaled to state population, by Event Type

I brought in the population estimates for each state contained in the 'state' dataset included in the 'datasets' [package](https://stat.ethz.ch/R-manual/R-devel/library/datasets/html/state.html) in R.  The estimates are from 1975 and therefore not entirely accurate, but for the most part populous states are still populous and sparsely populated states are still sparsely populated.  Scaling the impacts to state population allows more accurate estimates of storm event impact on population health.
```{r pophealthstate, cache=TRUE, message=FALSE, warning=FALSE}
#state.x77

statex77 <- as.data.frame(state.x77, stringsAsFactors=FALSE)
stateinfo2 <- cbind(state.abb,statex77)

stormdata <- left_join(stormdata,stateinfo2)

## Checking the join
nrow(stormdata)
# table(stormdata$state.abb, useNA = "always")
# table(stormdata$state.division, useNA = "always")

## Removing some unnecessary variables
stormdata <- stormdata %>%
    select(-Illiteracy, -Murder, -contains("Grad"), -Frost, -Area)


### Creating data frames for plotting below
byevtypestatepop <- stormdata %>%
    group_by(state.abb, evtype) %>%
    summarize(injper1000 = (sum(injuries)/1000), deathsper1000 = (sum(deaths)/1000))
```

  
  
  

3) Population Health Impact by Event for each State
```{r healthbystateplot}

plot1 <- ggplot(byevtypestatepop, aes(x = state.abb, y = deathsper1000, fill = evtype)) +
    geom_bar(stat = "identity") +
    theme_bw(base_size = 12, base_family= "") +
    ylab("Deaths per 1000 population") +
    xlab("State") +
    ggtitle("Figure 3: Deaths per 1000 by U.S. State") +
    labs(fill = "Event Type") +
    theme(axis.title.x = element_text(face="bold"), axis.title.y = element_text(face="bold"),
          axis.text.x = element_text(angle=90), title = element_text(face="bold"))
plot1

### Cleaning up
rm(plot1)
rm(byevtypestatepop)
```

The geographic distribution of storm events is shown in the wide variation in causes of storm-associated mortality in different U.S. states.

  
  
  

Results - Economic Impact of Storm Events
-----------------------------------------
  
1) Economic Impact per Event
```{r econimpact}
byevtype2 <- stormdata %>%
    rename(EventType = evtype) %>%
    group_by(EventType) %>%
    summarize(
        Count = n(),
        Property = format((sum(propdmg)/(Count*1000)), big.mark=",", digits=3), 
        Crop = format((sum(cropdmg)/(Count*1000)), big.mark=",", digits=3)) %>%
    select(EventType, Count, Property, Crop)
# byevtype2
```

  
  
  
  
```{r econimpact table}
htmlTable(byevtype2,
          rnames = FALSE,
         # header = c("Event Type", "Mean Property Damage ($)", "Mean Crop Damage ($)"),
          caption = "<a name=table02></a> <b> Table 2 </b> Mean Damage per Event ($thousands)",
          align = "llll",
          align.header = "llll")
```

Tropical depressions/storms and hurricanes cause the most property and crop damage per storm event.  They are rare and do not occur in every state (see [Figure 2][fig2] above), but they cause tremendous amounts of property and crop damage.  Drought causes the second-most crop damage per event, but little property damage.  Other rainstorms, fires, and floods are fairly common and also cause significant property and crop damage.

  
  
  

2) Overall Economic Impact
```{r econimpact2}
byevtype2 <- stormdata %>%
    rename(EventType = evtype) %>%
    group_by(EventType) %>%
    summarize(
        Count = n(),
        Property = format((sum(propdmg)/1000000), big.mark=",", digits=3), 
        Crop = format((sum(cropdmg)/1000000), big.mark=",", digits=3)) %>%
    select(EventType, Count, Property, Crop)

htmlTable(byevtype2,
          rnames = FALSE,
         # header = c("Event Type", "Mean Property Damage ($)", "Mean Crop Damage ($)"),
          caption = "<a name=table03></a> <b> Table 3 </b> Damage per Storm Event Type ($millions)",
          align = "llll",
          align.header = "llll")
```

Overall, flood events cause the most property damage, and are close behind drought events in causing the most crop damage.  Tropical storms/depressions and hurricanes cause the second-most property damage overall, despite the fact that they are rare.  Other rainstorm and tornado events calso cause significant property damage.  Winter storms also cause major crop damage.
  
  
  
[fig2]: Proj2_files/figure-html/eventsbystateplot-1.png "Figure 2"

  
  
  
Reference Materials
-------------------

  
1) Details about the variables in the NOAA Storm Events database can be found [here](ftp://ftp.ncdc.noaa.gov/pub/data/swdi/stormevents/csvfiles/Storm-Data-Export-Format.docx).

2) Complete documentation of the NOAA Storm Events database can be found [here](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf).

3) FAQ about the NOAA Storm Events database can be found [here](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2FNCDC%20Storm%20Events-FAQ%20Page.pdf).

  
  





